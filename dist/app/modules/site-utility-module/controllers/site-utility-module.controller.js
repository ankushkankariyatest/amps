!function(){"use strict";define(["assetIt","jsondiffpatch","jsondiffpatch-formatters","grid-grouping","grid-filtering","filter-options","kendo-plugin","angularjs-dropdown-multiselect","site-utility-module-services","utility-model-grid-configs"],function(e,t,i){e.register.controller("sitesUtilityModuleController",["$scope","$rootScope","siteUtilityModuleServices","utilityModelGridConfigs","isMobileView","$compile","$q","popupService","$timeout","authenticationFactory","notifyService","besDefaultColumns",function(e,u,r,s,f,v,A,T,G,l,g,S){function m(t){var s={sheetName:t,user:l.getUserName()};r.loadUtilityData(s).then(function(m){var p=m;if(c=p,p){var s=_.find(o,{sheetName:t});if(s){n=[],e.recordDate=s.dataUpdated;var f=[],g=[],h=[];_.each(s.primaryKey,function(e,o){var n=s.headers[e];n=n.length>i?n.substring(0,i-1)+"...":n;var r={field:e,title:n,groupable:!1,filterable:{extra:!1},headerAttributes:{title:s.headers[e],style:"min-width: 150px"}};-1===$.inArray(t,a)?r.groupHeaderTemplate=s.headers[e]+": #= value # (Count: #= count#)":0===o&&(r.hidden=!0),f.push(r),g.push({id:e,label:s.headers[e],disabled:!0})}),_.each(s.headers,function(t,e){h.push({id:e,label:s.headers[e]})});var v;_.each(s.groupData,function(e,t){"Primary"!==e.groupName?n.push(e):v=e});var b={context:e.activeTabInfo.sheetName,createdBy:l.getUserName()};r.getUserPreferences(b).then(function(o){var v=!1,n=_.where(o.info,{key:"columns"}),r=_.where(o.info,{key:"group"}),l=_.where(o.info,{key:"filter"});if(r=r.length>0&&-1===$.inArray(t,a)?r[0].data:[],n.length>0&&-1===$.inArray(t,d))v=!0,_.each(Object.keys(n[0].data),function(e,o){var a=_.where(g,{id:e}),r=_.where(h,{id:e}),t=n[0].data[e];t=t.length>i?t.substring(0,i-1)+"...":t,0===a.length&&r.length>0&&(f.push({field:e,title:t,groupable:!1,filterable:{extra:!1},groupHeaderTemplate:n[0].data[e]+": #= value # (Count: #= count#)",headerAttributes:{title:n[0].data[e],style:"min-width: 150px"}}),g.push({id:e,label:n[0].data[e]})),$("a.dropdown-toggle").bind("click",function(){$("ul.dropdown-menu.dropdown-menu-form").css("display","none")})});else{var y=_.find(S,{sheetName:t});_.each(y.defaultColumns,function(e,n){var a=_.where(g,{id:e.id}),t=e.label;t=t.length>i?t.substring(0,i-1)+"...":t,0===a.length&&g.length<=4&&(f.push({field:e.id,title:t,groupable:!1,filterable:{extra:!1},groupHeaderTemplate:e.label+": #= value # (Count: #= count#)",headerAttributes:{title:e.label,style:"min-width: 150px"}}),g.push({id:e.id,label:e.label}))})}e.columnPrefSet=v,e.selectedCols=g,e.initialSelectedGroup=[].concat(r),e.initialSelectedCols=[].concat(g),e.colsList=h,e.columns=f,e.savePrefEnabled=!1,e.hideGridColumnPref=$.inArray(t,d)>-1,_.each(l,function(e,t){e.isDuplicate="DUPLICATE"===e.data[0].operator}),e.filteringPlugin={columns:e.columns},e.filterPreferences=l?l:[],u.cols=s.masterheaders;var C=[].concat(e.columns);if(e.config.refreshGrid(C),e.config.updateGrid(c),e.groupingPlugin={columns:e.columns,activeGroupColumns:r?r:[]},$.inArray(t,a)>-1){e.groupingPlugin.activeGroupColumns.push(e.columns[0]);var m=e.groupingPlugin&&e.groupingPlugin.activeGroupColumns?e.groupingPlugin.activeGroupColumns:null;if(m){e.initialSelectedGroup=[].concat(m),$("#grid").getKendoGrid().dataSource.group(m),$("#grid").getKendoGrid().dataSource.sort({field:"order",dir:"asc"}),$("#grid").getKendoGrid().dataSource.pageSize(p.length);var b={refresh:!1,input:!0,numeric:!1,pageSize:p.length,pageSizes:[p.length]};$("#grid").getKendoGrid().setOptions({pageable:b}),$("#grid").getKendoGrid().setOptions({sortable:!1})}}else{$("#grid").getKendoGrid().dataSource.pageSize(20);var b={refresh:!1,input:!0,numeric:!1,pageSize:20,pageSizes:[20,50,100,200]};$("#grid").getKendoGrid().setOptions({pageable:b}),$("#grid").getKendoGrid().setOptions({sortable:!0})}e.hideGridAdvancedOptions=$.inArray(t,P)>-1})}}})}function h(){var i={},a=p;a&&""!=a.trim()&&(i=t.searchFilters);var r=_.uniq(_.pluck(_.where(t.pluginFilters.filters,{operator:"DUPLICATE"}),"field"));if(r.length>0){var n=[];_.each(r,function(e,i){var t=_.groupBy(c,e);_.each(t,function(e,t){""!==t&&e.length>1&&(n=_.union(n,e))})}),e.config.updateGrid(n),e.filterGridByFilterPlugin(i)}else t.pluginFilters&&t.pluginFilters.logic&&(i=t.pluginFilters),a&&""!=a&&t.pluginFilters&&t.pluginFilters.logic&&(i={logic:"and",filters:[]},t.searchFilters.filters.length>0&&i.filters.push(t.searchFilters),t.pluginFilters.filters.length>0&&i.filters.push(t.pluginFilters)),e.config.updateGrid(c),e.filterGridByFilterPlugin(i)}e.columns=[];var o=[];e.selectedCols=[],e.colsList=[],e.savePrefEnabled=!1,e.colsSettings={enableSearch:!0,scrollableHeight:"500px",scrollable:!0,showCheckAll:!1,showUncheckAll:!1};var c=[],i=45,n=[],b=["SiteName","HighestCIPV5BCSImpactRating","FutureV5BCSImpactRating","ExpectedDateforFutureV5BCSImpactRatingEDRO","CIPV3CARating","SiteSecurityTypeandProfileFutureUse","SiteCategoryType","_11ReliabilityCoordinator","_12BalancingAuthority","_13TOAssetsmeetcriterion222425272829or210","_14GOAssetsmeetcriterion212326or29","_211GO1500MW","_212TOnotHighisMed","_213BA1500MW","_31LowBA1500MW","Details","SiteType"],y=["SiteName","HighestCIPV5BCSImpactRating","FutureV5BCSImpactRating","ExpectedDateforFutureV5BCSImpactRatingEDRO","CIPV3CARating","SiteSecurityTypeandProfileFutureUse","_36Fromsection421Low","_35SPSLow","_34RestorationsystemsLow","_32TransmissionstationsandsubstationsLow","_28RequiredforGenerationSiteInterconnection","_27NuclearPlantInterfaceOPO23","_26CriticalforIROLs","_25bWeightedlineAveragesum","_25a200kV299kV230kVonly","_25MedCriteriaapplies","_24500kVorhigher","_210AutomaticLoadShedding","_29SpecialProtectionSystemSPSorRemedialActionSchemeRAS","_22MedCriteriaapplies","_22cShuntReactorsTotalCapacityMVA","_22dShuntReactorCyberComponent","_22bCapBankCyberComponent","_22aCapacitorBanksTotalCapacityMVA","MaximumkV","SiteType"],C=["SiteName","HighestCIPV5BCSImpactRating","FutureV5BCSImpactRating","ExpectedDateforFutureV5BCSImpactRatingEDRO","CIPV3CARating","SiteSecurityTypeandProfileFutureUse","GenerationType","_21Generationexceeding1500MWinasingleInterconnection","_23Impactintheplanninghorizonofmorethanoneyear","_33GenerationResources","SiteType"],P=["EACMS","PACS","ChangeLog"],d=["ChangeLog"],a=["EACMS","PACS"],w=670;e.colsTranslationTexts={selectionCount:"Selected",dynamicButtonTextSuffix:"Selected"},e.colsEvents={onItemSelect:function(r){var a=_.where(e.colsList,{id:r.id})[0],t=a.label;t=t.length>i?t.substring(0,i-1)+"...":t,e.columns.push({field:a.id,title:t,groupable:!1,filterable:{extra:!1},groupHeaderTemplate:a.label+": #= value # (Count: #= count#)",headerAttributes:{title:a.label,style:"min-width: 150px"}});var o=[].concat(e.columns);e.config.refreshGrid(o);var n=e.groupingPlugin&&e.groupingPlugin.activeGroupColumns?e.groupingPlugin.activeGroupColumns:null;n&&$("#grid").getKendoGrid().dataSource.group(n),e.savePrefEnabled=!angular.equals(e.groupingPlugin.activeGroupColumns,e.initialSelectedGroup)||!angular.equals(e.selectedCols,e.initialSelectedCols)},onItemDeselect:function(n){for(var i=0;i<e.columns.length;i++)if(e.columns[i].field===n.id){e.columns.splice(i,1);break}var r=[].concat(e.columns);e.config.refreshGrid(r);var t=e.groupingPlugin&&e.groupingPlugin.activeGroupColumns?e.groupingPlugin.activeGroupColumns:null;if(t){for(var a=t.length;a--;)n.id===t[a].field&&t.splice(a,1);$("#grid").getKendoGrid().dataSource.group(t)}e.savePrefEnabled=!angular.equals(e.groupingPlugin.activeGroupColumns,e.initialSelectedGroup)||!angular.equals(e.selectedCols,e.initialSelectedCols)}},e.initializeController=function(){e.indexActive=0,e.config=s.getConfigs(),e.config.height=w,e.config.detailTemplate=kendo.template($("#template").html()),e.config.detailInit=function(h){for(var w=h.detailRow,r=h.data,i={},d=[],t=angular.extend({},r),o=0;o<e.columns.length;o++)d.push(e.columns[o].field),t[e.columns[o].field]&&delete t[e.columns[o].field];if("Site"===e.activeTabInfo.sheetName){var f=r.SiteType;switch(f=f?$.trim(f.toLowerCase()):""){case"control center":case"data center":Object.keys(t).forEach(function(e){$.inArray(e,b)<0&&delete t[e]});break;case"substation":case"support site":Object.keys(t).forEach(function(e){$.inArray(e,y)<0&&delete t[e]});break;case"generation":Object.keys(t).forEach(function(e){$.inArray(e,C)<0&&delete t[e]})}}i.generalItem=t,i.sheetName=e.activeTabInfo.sheetName,i.key=e.activeTabInfo.primaryKey;var g="";_.each(e.activeTabInfo.primaryKey,function(e,t){g=""===g?u.cols[e]+":"+r[e]:g+"; "+u.cols[e]+":"+r[e]}),i.title=g,i.rowData=r,i.cols=u.cols;var p=[].concat(n);if(n&&n.length>0){_.each(n,function(e,t){_.each(e.dataObject,function(e,t){d.push(e)})});var c=(_.pluck(e.colsList,"id"),_.filter(_.keys(t),function(e,t){return-1===$.inArray(e,d)}));c.length>0&&p.splice(0,0,{groupName:"General",dataObject:c})}else{var c={};_.each(_.keys(t),function(e,t){-1===$.inArray(e,d)&&(c[e]=e)}),_.keys(c).length>0&&p.push({groupName:"General",dataObject:c})}i.groupsData=p;var m=w.find(".detailTabstrip").kendoTabStrip({animation:{open:{effects:"fadeIn"}},select:function(t){var a=S[t.item.textContent];if(""!=a){var n=A.defer();return require([a.directiveRef],function(){e.$apply(function(){e.data=i,n.resolve(v(t.contentElement)(e))})}),n.promise}}}).data("kendoTabStrip"),l={};l.dynamicGroups=p,l.showHistory=-1===$.inArray(e.activeTabInfo.sheetName,a),l.showFeedback=-1===$.inArray(e.activeTabInfo.sheetName,a),l.showVersionComparer=-1===$.inArray(e.activeTabInfo.sheetName,a),s.setTabConfigs(l,i);var S=s.getTabConfigs();angular.forEach(S,function(e){m.append(e)}),m.select(0)},e.config.dataBound=function(t){e.activeTabInfo&&e.activeTabInfo.sheetName&&($.inArray(e.activeTabInfo.sheetName,d)>-1&&($(".k-hierarchy-cell").remove(),$(".k-hierarchy-col").remove()),$.inArray(e.activeTabInfo.sheetName,a)>-1&&($("#grid").find("tbody tr.k-grouping-row").next("tr").css({"font-style":"italic","font-weight":"bold","background-color":"#ebf4fa"}),$("#grid").find("tbody tr.k-grouping-row").next("tr").find("span.watch").hide()))};var t;e.config.detailExpand=function(e){e.detailRow.find(".detailTabstrip").data("kendoTabStrip").select(0),$(".open").removeClass("open"),$("ul.dropdown-menu.dropdown-menu-form").css("display","none"),null!=t&&t[0]!=e.masterRow[0]&&$("#grid").data("kendoGrid").collapseRow(t),t=e.masterRow},f?e.config.groupable=!f:e.config.groupable={messages:{empty:""}},r.getUtilityInfo().then(function(t){o=_.object(_.pluck(t,"sheetName"),t),e.allTabs=t;var i=_.where(e.allTabs,{order:1});i.length>0?e.callActiveTab(0,i[0].sheetName):e.savePrefEnabled=!1})},e.callActiveTab=function(i,t){e.savePrefEnabled&&e.saveUserCols(),e.indexActive=i,e.activeTabInfo=o[t],$("#txtSearchString")[0].placeholder="Search in "+o[t].displayName,m(e.activeTabInfo.sheetName)};var t={searchFilters:{},pluginFilters:{}},p="";e.filterGridRecord=function(i){p=i,t.searchFilters=s.getDefaultFilterWithFilterText(i,e.columns),h(),e.highlight(i)},e.callbackFilter=function(e){t.pluginFilters=e,h()},e.callbackGroup=function(){e.savePrefEnabled=!angular.equals(e.groupingPlugin.activeGroupColumns,e.initialSelectedGroup)||!angular.equals(e.selectedCols,e.initialSelectedCols)},e.updateFeedbackCount=function(e,t){},$("a.dropdown-toggle").on("click",function(){$("ul.dropdown-menu.dropdown-menu-form").css("display","none")}),e.saveUserCols=function(){var t={context:e.activeTabInfo.sheetName,identifier:"primary",createdBy:l.getUserName(),data:{columns:{},group:{}}};-1===$.inArray(e.activeTabInfo.sheetName,a)&&(t.data.group=e.groupingPlugin.activeGroupColumns),_.each(e.selectedCols,function(i,a){i.disabled||(t.data.columns[i.id]=_.where(e.colsList,{id:i.id})[0].label)}),r.updateUserPreferences(t).then(function(t){e.initialSelectedCols=[].concat(e.selectedCols),e.savePrefEnabled=!1,g.notifySuccess({title:"Asset Management Platform",text:"Saved user preferences",type:"success"})})},$("div.gridRequiredClass").on("click","span.watch",function(c){var t=$(this),i=$("#grid").data("kendoGrid").dataItem(t.closest("tr")),a=_.find(o,{sheetName:e.activeTabInfo.sheetName});if(a){var n={};_.each(a.primaryKey,function(e,t){n[e]=i[e]});var s={sheetName:a.sheetName,user:l.getUserName(),keys:n};!i.notify||t.hasClass("icon-watch-add")?r.addUserWatchList(s).then(function(e){e.isSuccess&&(i.notify=!0,g.notifySuccess({title:"Asset Management Platform",text:"Added to watch list",type:"success"}),t.removeClass("icon-watch-add").addClass("icon-watch-remove").attr("title","Remove watch"))}):r.removeUserWatchList(s).then(function(e){e.isSuccess&&(i.notify=!1,g.notifySuccess({title:"Asset Management Platform",text:"Removed watch list",type:"success"}),t.removeClass("icon-watch-remove").addClass("icon-watch-add").attr("title","Add watch"))})}})}])})}();