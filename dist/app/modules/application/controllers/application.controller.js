!function(e,t){"use strict";define(["assetIt","applicationService","app-config","filter-options","kendo-plugin","FeedbackTicket","bootstrap-popup","grid-grouping","grid-filtering"],function(i){i.register.controller("appController",["$scope","$rootScope","$q","$compile","applicationService","$routeParams","$location","configUrl","appConfig","appConstantPath","authenticationFactory","popupService",function(i,r,u,g,c,d,v,A,l,a,f,o){function I(){var e={},t=P;t&&""!=t.trim()&&(e=n.searchFilters);var o=_.uniq(_.pluck(_.where(n.pluginFilters.filters,{operator:"DUPLICATE"}),"field"));if(o.length>0){var r=[];_.each(o,function(e,i){var t=_.groupBy(p,e);_.each(t,function(e,t){""!==t&&e.length>1&&(r=_.union(r,e))})}),i.config.updateGrid(r),i.filterGridByFilterPlugin(e)}else n.pluginFilters&&n.pluginFilters.logic&&(e=n.pluginFilters),t&&""!=t&&n.pluginFilters&&n.pluginFilters.logic&&(e={logic:"and",filters:[]},n.searchFilters.filters.length>0&&e.filters.push(n.searchFilters),n.pluginFilters.filters.length>0&&e.filters.push(n.pluginFilters)),d.id&&(e=i.config.dataSource.filter),i.config.updateGrid(p),i.filterGridByFilterPlugin(e)}function b(t,i){var e=[];return _.each(t,function(t){t.processInfo=k(t,i),t.lobInfo=C(t),t.isEnterprise=h,e.push(t)}),e}function k(r,o){var a="PROCESS",t="",i=r[a],n=[];if(null==i||"undefined"==i)t=i;else{var e=m(i,";#");1==e.length?(t=e[0],n.push(o[e[0]])):e.length>1&&(t="Multiple",_.each(e,function(t,i){var e=o[t];e=void 0===e?{CODE:t}:e,n.push(e)}))}return r.modifiedProcessValue=t,n}function m(i,e){var t=0==i.indexOf(e)?i.substr(e.length,i.length-e.length):i;return t=t.lastIndexOf(e)==t.length-e.length?t.substr(0,t.length-e.length):t,t.split(e)}function C(r){var o="LINE_OF_BUSINESS",t="",i=r[o],n=[];if(null==i||"undefined"==i)t="";else{var e=m(i,";#");1==e.length?(t=e[0],n.push(e[0])):e.length>1&&(t="Multiple",_.each(e,function(e,t){n.push(e)}))}return r.modifiedLobValue=t,n}var n={searchFilters:{},pluginFilters:{}},P="",p=[],h=f.userRole.indexOf(f.userRoles.enterprise)>-1;i.contextVal="APPLICATION",i.initializeController=function(){var t=l.getConfigs();i.config=t,i.config.dataBound=function(t){e("[data-toggle='tooltip']").tooltip()},i.config.groupable={messages:{empty:""}},i.bacrConfig=l.getBacrConfigs(),i.config.filterable={extra:!1,operators:{string:{eq:"Is equal to",neq:"Is not equal to"}}},i.config.detailTemplate=kendo.template(e("#template").html()),i.config.detailInit=function(t){var n=t.detailRow,r=n.find(".tabstrip").kendoTabStrip({animation:{open:{effects:"fadeIn"}},select:function(t){if(t.item.textContent.indexOf("Feedback")>-1&&g(t.contentElement)(i),t.item.textContent.indexOf("Certification")>-1){g(t.contentElement)(i);var r={context:"APPLICATION",id:e(t.item).attr("attr-id")};c.getCertifyApps(r).then(function(e){e.isSuccess&&i.bacrConfig.updateGrid(e.response)})}if(t.item.textContent.indexOf("Infrastructure")>-1){var n=u.defer();return require(["app-infra-wrapper-tab"],function(){i.$apply(function(){n.resolve(i.$on("$destroy",g(t.contentElement)(i)))})}),n.promise}}}).data("kendoTabStrip");r.select(0)},c.getAppRecords().then(function(t){var n=t[0],r=_.object(_.pluck(n,"CODE"),n),e=b(t[1],r);c.getAllApplicationFeedbackCount().then(function(t){var r=_.object(_.pluck(t,"ID"),t);_.each(e,function(e){var i=r[e.APP_ID];e.COUNT=void 0===i?0:i.COUNT;for(var t in e)e[t]=null!=e[t]&&"object"!=typeof e[t]?e[t]:Array.isArray(e[t])?e[t]:""});var n=l.getCustomGroupConfigureData();i.groupingPlugin={columns:n,activeGroupColumns:[]};var o={context:"APPLICATION",createdBy:f.getUserName()};c.getUserPreferences(o).then(function(t){var e=_.where(t.info,{key:"filter"});_.each(e,function(e,t){e.isDuplicate="DUPLICATE"===e.data[0].operator}),i.filteringPlugin={columns:n},i.filterPreferences=e?e:[]}),p=e,i.config.updateGrid(e)},function(t){p=e,i.config.updateGrid(e),console.log("application feedback Count failed.."+t)}),c.getAllApplicationCertificationCount().then(function(t){var n=t;_.each(e,function(e){var t=0,i=0;_.each(_.where(n,{ID:e.APP_ID.toString()}),function(e){switch(e.STATUS){case"1":t=parseInt(e.COUNT);break;case"0":default:i+=parseInt(e.COUNT)}}),e.CertificationCount=t,e.CertificationRejectCount=i,e.CertificationTotalCount=t+i}),p=e,i.config.updateGrid(e)},function(t){p=e,i.config.updateGrid(e),console.log("application feedback Count failed.."+t)})},function(e){console.log("application service failed.."+e)}),d.id&&(i.filteredState=!0,i.config.pageable=!1,i.config.dataSource.filter=t.routeParamFilter(d.id))},i.filterGridRecord=function(e){var t=l.getConfigs();i.filterGrid(e,t.getDefaultFilterWithFilterText(e))};var s={process:{templateUrl:a.application.multiProcessTemplateUrl,routePath:"/mcps/"},lob:{templateUrl:a.application.multiLobsTemplateUrl,routePath:"/lobs?name="}};r.routeToProcess=function(e,t){o.closePopup();var i=s[e].routePath+t;v.url(i,!0)},e("div.gridRequiredClass").on("click","a.processLinkMultiple",function(t){r.selectedItem=e("#grid").data("kendoGrid").dataItem(e(this).closest("tr")),o.showApplicationPopup(s.process.templateUrl)}),e("div.gridRequiredClass").on("click","a.lobLinkMultiple",function(t){r.selectedItem=e("#grid").data("kendoGrid").dataItem(e(this).closest("tr")),o.showApplicationPopup(s.lob.templateUrl)}),e("div.gridRequiredClass").on("click","a.processDetailMultiple",function(t){r.selectedItem=e("#grid").data("kendoGrid").dataItem(e(t.currentTarget).closest("tr").prev("tr")),o.showApplicationPopup(s.process.templateUrl)}),e("div.gridRequiredClass").on("click","a.lobDetailMultiple",function(t){r.selectedItem=e("#grid").data("kendoGrid").dataItem(e(t.currentTarget).closest("tr").prev("tr")),o.showApplicationPopup(s.lob.templateUrl)}),e("div.gridRequiredClass").on("click","span.bacr",function(n){var i=e("#grid").data("kendoGrid").dataItem(e(this).closest("tr"));l.clearApplication(),l.setApplication(i);var t=u.defer();return require([a.application.applicationSystemInfoControllerUrl],function(){r.$apply(function(){t.resolve(o.showApplicationBacrPopup(a.application.bacrTemplateUrl))})}),t.promise}),e("div.gridRequiredClass").on("click","span.appBacr",function(i){var t=e("#certifyGrid").data("kendoGrid").dataItem(e(this).closest("tr"));l.clearApplication(),c.getCertifyAppData(t.ID).then(function(t){var e=t.response.DATA;e.comment=t.response.COMMENTS,e.oldData=!0,l.setApplication(e);var i=u.defer();return require([a.application.applicationSystemInfoControllerUrl],function(){r.$apply(function(){i.resolve(o.showApplicationBacrPopup(a.application.bacrTemplateUrl))})}),i.promise})}),e("div.gridRequiredClass").on("click","a.systemInfo",function(i){r.selectedItem=e("#grid").data("kendoGrid").dataItem(e(i.currentTarget).closest("tr")),r.appId=r.selectedItem.APP_ID;var t=u.defer();return require([a.application.applicationSystemInfoControllerUrl],function(){r.$apply(function(){t.resolve(o.showApplicationSystemInfoPopup(a.application.appSystemInfoTemplateUrl))})}),t.promise}),i.updateFeedbackCount=function(i,n){t.forEach(e("#grid").data().kendoGrid.dataSource.data(),function(e){e.APP_ID==i&&(e.COUNT=n)});var r=e(".feedbackCount"+i);r.html(n),r.parent().removeClass("hide")},i.callbackFilter=function(e){n.pluginFilters=e,I()}}])})}($,angular);