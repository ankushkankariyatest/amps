!function(){define(["assetIt","notify-service","kendo-plugin","jquery-ui.min","angular-dragdrop","site-excel-import-services","site-excel-import-model"],function(e){e.register.controller("siteExcelImportController",["$scope","$rootScope","$compile","$q","authenticationFactory","siteExcelImportService","siteExcelImportModelGridConfigs","popupService","loadingData","notifyService",function(e,p,i,s,a,t,r,d,h,o){e.masterColList=[],e.sheetInfo=[],e.sheetGroups={sheetData:[],selectedSheet:"",showGroup:!1},e.multiOptions={dataSource:[],dataTextField:"value",dataValueField:"id"};var n=["ChangeLog","EACMS","PACS"],u=[{sheetName:"Site",keys:[]},{sheetName:"CyberSystem",keys:[]},{sheetName:"CyberAsset",keys:[{field:"CyberSystem",title:"Cyber System"}]},{sheetName:"Decommissioned",keys:[{field:"CyberSystem",title:"Cyber System"}]}];e.initializeController=function(){e.isAdmin=a.userRole.indexOf(a.userRoles.admin)>-1,e.isNercCip=a.userRole.indexOf(a.userRoles.nercCip)>-1,e.indexActive=1,e.importExelConfig=r.getImportExelConfig(),e.importExelConfig.detailTemplate=kendo.template($("#importTemplate").html()),e.importExelConfig.detailInit=function(o){var n=o.detailRow,p={},a={};t.getExceptionRecords(o.data.startTime).then(function(c){var t=c;_.each(t,function(t,i){var a=_.find(e.sheetData,{sheetName:t._id});if(a){var r=[];_.each(a.primaryKey,function(e,t){r.push({field:e,title:a.headers[e]?a.headers[e]:e})});var s=_.find(u,{sheetName:t._id});s&&s.keys&&_.each(s.keys,function(e,t){_.find(r,{field:e.field})||r.unshift(e)}),t.primaryKeys=r,t.displayName=a.displayName,t.cols=a.masterheaders,t.detailRow=n}}),a.startTime=o.data.startTime,a.data=t,p.dynamicGroups=t;var d=n.find(".tabstrip").kendoTabStrip({animation:{open:{effects:"fadeIn"}},select:function(t){var r=h[t.item.textContent];if(""!=r){var o=s.defer();return require([r.directiveRef],function(){e.$apply(function(){e.data=a,o.resolve(i(t.contentElement)(e))})}),o.promise}}}).data("kendoTabStrip");r.setTabConfigs(p,a);var h=r.getTabConfigs();angular.forEach(h,function(e){d.append(e)}),d.select(0)})},e.refreshGrid(),e.refreshPrimaryTab()},e.manualImport=function(){t.manualImport({userEmail:a.user})},e.manualImportUsers=function(){t.manualImportUsers({userEmail:a.user})},e.refreshGrid=function(a){e.indexActive=a?a:e.indexActive,t.getLogs().then(function(t){e.importExelConfig.updateGrid(t)})},e.refreshPrimaryTab=function(a){e.indexActive=a?a:e.indexActive,t.getSheetNameAndLatestVersion().then(function(t){e.sheetData=_.filter(t,function(e,t){return-1===$.inArray(e.sheetName,n)})})},e.getSheetGroupData=function(){e.sheetGroups.sheetData=[],e.sheetGroups.selectedSheet&&t.getGroupData(e.sheetGroups.selectedSheet.sheetName).then(function(s){e.sheetGroups.showGroup=!0;e.masterColList=[];var i=[],t=s.isSuccess?s.groupsData:[];_.each(t,function(t,r){var a=[];_.each(t.dataObject,function(t,r){t&&e.sheetGroups.selectedSheet.headers[t]&&(a.push({id:t,title:e.sheetGroups.selectedSheet.headers[t],drag:!0}),i.push({id:t}))}),t.dataObject2=a}),_.each(Object.keys(e.sheetGroups.selectedSheet.headers),function(t,r){var a=_.where(i,{id:t});a.length<=0&&-1===$.inArray(t,e.sheetGroups.selectedSheet.primaryKey)&&e.masterColList.push({title:e.sheetGroups.selectedSheet.headers[t],id:t,drag:!0})});var a=_.find(t,{groupName:"Primary"});if(a){if(0===a.dataObject2.length){var o=_.find(e.sheetData,{sheetName:e.sheetGroups.selectedSheet.sheetName}).primaryKey,n=[];_.each(o,function(t,a){n.push({id:t,title:e.sheetGroups.selectedSheet.headers[t]})}),a.dataObject2=n}}else{var o=_.find(e.sheetData,{sheetName:e.sheetGroups.selectedSheet.sheetName}).primaryKey,r={groupName:"Primary",dataObject:[],dataObject2:[]};_.each(o,function(t,a){r.dataObject.push(t),r.dataObject2.push({id:t,title:e.sheetGroups.selectedSheet.headers[t]})}),t.unshift(r)}e.sheetGroups.groupData=t;var u=[];for(var p in e.sheetGroups.selectedSheet.headers)u.push({id:p,value:e.sheetGroups.selectedSheet.headers[p]});e.multiOptions.dataSource=u})},e.addGroup=function(){e.sheetGroups.groupData.push({groupName:"",dataObject:[],dataObject2:[]})},e.removeGroup=function(a){for(var t=0;t<e.sheetGroups.groupData.length;t++)if(e.sheetGroups.groupData[t].groupName===a.groupName){_.each(e.sheetGroups.groupData[t].dataObject2,function(t,r){var a=_.find(e.masterColList,{id:t.id});a||e.masterColList.push({title:e.sheetGroups.selectedSheet.headers[t.id],id:t.id,drag:!0})}),e.sheetGroups.groupData.splice(t,1);break}},e.$watch("masterColList",function(t){e.masterColList=_.sortBy(e.masterColList,"title")},!0),e.saveGroups=function(){var s=[];for(var r in e.sheetGroups.groupData)if(""!=e.sheetGroups.groupData[r].groupName){var i=[];_.each(e.sheetGroups.groupData[r].dataObject2,function(e,t){i.push(e.id)}),s.push({groupName:e.sheetGroups.groupData[r].groupName,dataObject:i})}var n={createdBy:a.user,groupData:s,sheetName:e.sheetGroups.selectedSheet.sheetName};t.postGroupData(n).then(function(e){o.notifySuccess({title:"Asset Management Platform",text:"Group configuration saved",type:"success"})})},e.validForm=function(){if(!e.sheetData||e.sheetData.length<=0)return!0;if(!e.sheetGroups.groupData||e.sheetGroups.groupData.length<=0)return!0;var a=0;for(var t in e.sheetGroups.groupData){if(""===e.sheetGroups.groupData[t].groupName)return!0;if(e.sheetGroups.groupData[t].dataObject2.length<=0)return!0;"Primary"===e.sheetGroups.groupData[t].groupName&&a++}return a>1?!0:!1},e.removeAttribute=function(a,r){for(var t=0;t<r.dataObject2.length;t++)if(r.dataObject2[t].id===a.id){r.dataObject2.splice(t,1),e.masterColList.push({title:a.title,id:a.id,drag:!0});break}},e.dataChanged=function(t){for(var r=e.sheetGroups.groupData,s=r.indexOf(t),a=0;a<r.length;a++){if(a!=s&&r[a].groupName===t.groupName){t.groupName="",t.isError=!0;break}t.isError=!1}}}])})}();