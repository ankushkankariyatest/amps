!function(){"use strict";define(["assetIt","authentication-factory","bootstrap","bootstrap-popup"],function(e){e.register.directive("gridFiltering",["filterPluginModel","gridFilteringService","$timeout","popupService",function(t,e,i,r){return{restrict:"AE",templateUrl:"app/modules/common/grid-filtering/grid-filtering.html",scope:{context:"=",identifier:"@",key:"@",createdBy:"@",options:"=",callbackFilter:"&?",filterPreferences:"="},link:function(t,e,i){e.find(".dropdown-menu").click(function(e){e.stopPropagation()}),e.find(".openContainer").click(function(e){})},controller:["$scope",function(a){function P(){p={createPrefs:{callbackFunc:g},updatePrefs:{callbackFunc:F},applyPrefs:{callbackFunc:d}},m={getPrefs:{callbackFunc:f},deletePrefs:{callbackFunc:y},applyCallbackFunc:D},o=t.configurations,o.initializeDefaultModel(),o.setConfigurations(m),n=t.formConfigurations,n.setConfigurations(p),n&&n.form&&n.form.showForm&&(n.form.showForm=!1),a.filterForm=n,s={create:{service:e.addUserPreferences,pluginModel:o,method:"pushData"},update:{service:e.updateUserPreferences,pluginModel:o,method:"updateData"}},a.clearGridFilters()}function D(e){a.$evalAsync(a.callbackFilter()(e))}function h(e,i){var t=i.modelToPost;e.service(t).then(function(o){a.message="",a.filterForm.form.showForm=!a.filterForm.form.showForm;var r=e.pluginModel[e.method]({name:t.identifier,data:t.data});a.activePreference=r.activePreference,a.filterableViewData=l(r.info),d(i)},u)}function g(e){var t=n.validateForm();t?h(s.create,e):($(".error").html("Same name already exist. Please change filter name.."),i(function(){$(".error").html("")},2e3))}function F(e){h(s.update,e)}function u(e){console.log(e)}function v(){a.message="",a.filterPreferences&&a.filterPreferences.length>0?c(a.filterPreferences):(c([]),a.message="No filter created")}function c(e){if(e&&null!=e){var t=o.setDataAndCreateFilterModel(e);a.activePreference=t.activePreference,a.filterableViewData=l(t.info)}else a.filterableViewData=[]}function l(e){return _.each(e,function(e,t){_.each(e.data,function(t,r){var i=_.where(a.filterPlugin.columns,{field:t.field});0===i.length?(t.field="",e.isValid=!1):e.isValid=!0})}),e}function f(e){v()}function w(t){e.removeUserPreferences(t).then(function(t){a.message="",c(t.info);var e=_.filter(a.filterableViewData,{name:a.activePreference.identifier});0==e.length?a.clearGridFilters():o.setActivePreference(e[0])},u)}function y(e){r.showDeletePermissionPopup({isConfirm:w,data:e,message:"Are you sure you want to delete this filter?"})}function d(e){var t=e.filerToApply(e.modelToPost);a.$evalAsync(a.callbackFilter()(t))}var o,n,p,m,s;a.clearGridFilters=function(){o.setdefaultPreference(),a.$evalAsync(a.callbackFilter()({}))},a.$on("$destroy",a.$watch("options",function(e,t){if(void 0!==e&&e&&e!=t){a.filterPlugin={columns:e.columns,operators:[{field:"eq",title:"Is equal to"},{field:"neq",title:"Is not equal to"},{field:"startswith",title:"Starts with"},{field:"contains",title:"Contains"},{field:"doesnotcontain",title:"Does not contain"},{field:"endswith",title:"Ends with"}]};var i={context:a.context,identifier:a.identifier,key:a.key};P(),o.setScopeInfoIntoModel(i);var r=o.getScopeInfoFromModel();f(r)}},!0))}]}}]);var t;e.register.factory("filterPluginModel",["authenticationFactory",function(o){function n(o,c){this.applyFilter=function(){var e=i.viewData.activePreference;e.identifier=this.name,e.highlightedIndex=this.index;var t=r(this);i&&i.customOps&&"function"==typeof i.customOps.applyCallbackFunc&&i.customOps.applyCallbackFunc(t)},this.edit=function(){var i=e.form;i.showForm=!i.showForm,i.identifier=this.name,i.enabled=!1,i.record=this.data,i.isDuplicate=this.data.length>0&&"DUPLICATE"===this.data[0].operator,t=this.data[0].value,e.manupulateFormModel()},this["delete"]=function(){var e=angular.extend({},i.scopedInfo);e.identifier=this.name,i&&i.customOps&&i.customOps.deletePrefs&&"function"==typeof i.customOps.deletePrefs.callbackFunc&&i.customOps.deletePrefs.callbackFunc(e)};var l={edit:this.edit,"delete":this["delete"],applyFilter:this.applyFilter};if(!isNaN(c)){var f=[];return angular.forEach(o.data,function(e,t){f.push(angular.extend({},e,a))}),void(this.viewData.info[c].data=f)}if(o&&o.name&&o.data&&o.data.length>0)o=angular.extend({},l,o),o.index=this.viewData.info.length,this.viewData.info.push(o);else{var s=this.getData();this.viewData.info=[];for(var n=0;n<s.length;n++)s[n]=angular.extend({},l,s[n]),s[n].index=n,this.viewData.info.push(s[n])}}function s(){var t=e.form.viewData;1==t.length?(this.logic="",this.value=""):t.length>1&&(0!=this.index&&t.length-1==this.index&&(t[this.index-1].logic=""),t.splice(this.index,1)),e.rebuildIndex()}function c(r){this.logic=r;var t=e.form.viewData;if(t.length-1==this.index){var o=e.getDefaultModel(),i=angular.extend({},o,a);i.index=t.length,t.push(i)}}function l(){e.form.viewData=[];for(var i=e.getFormData(),t=0;t<i.length;t++)i[t]=angular.extend({},i[t],a),i[t].index=t,e.form.viewData.push(i[t]);e.form.viewData[t-1].logic=""}function r(o){var t={logic:"or",filters:[]},r={logic:"and",filters:[]},i=[],e="",n=angular.extend({},o.data);angular.forEach(n,function(r,a){"and"==e&&"and"==r.logic||""==e&&"and"==r.logic?i.push(r):"or"==e&&"or"==r.logic||""==e&&"or"==r.logic?t.filters.push(r):"and"==e&&"or"==r.logic||""==e&&"or"==r.logic?i.push(r):"or"==e&&"and"==r.logic||""==e&&"and"==r.logic?i.push(r):""==r.logic&&"and"==e?i.push(r):t.filters.push(r),e=r.logic}),r.filters=i;var a={};return r.filters.length>0?(t.filters.push(r),a=t):a=t,a}var i={data:[],customOps:{},scopedInfo:{context:"",identifier:"",key:"",createdBy:""},viewData:{activePreference:{identifier:"No Filter",highlightedIndex:-1},info:[]},initializeDefaultModel:function(){this.data=[],this.customOps={},this.scopedInfo={context:"",identifier:"",key:"",createdBy:""},this.viewData={activePreference:{identifier:"No Filter",highlightedIndex:-1},info:[]}},setdefaultPreference:function(){this.viewData.activePreference.identifier="No Filter",this.viewData.activePreference.highlightedIndex=-1},setActivePreference:function(e){this.viewData.activePreference.identifier=e.name,this.viewData.activePreference.highlightedIndex=e.index},setDataAndCreateFilterModel:function(e){return this.viewData.info=[],this.data=e,this.createFilterModel(),this.viewData},setData:function(e){this.data=e},getData:function(){return angular.copy(this.data)},pushData:function(e){return this.data.push(e),this.createFilterModel(e),this.viewData.activePreference.identifier=e.name,this.viewData.activePreference.highlightedIndex=this.viewData.info.length-1,this.viewData},updateData:function(e){var t;return angular.forEach(this.data,function(i,r){i.name==e.name&&(i.data=e.data,t=r)}),this.createFilterModel(e,t),this.viewData.activePreference.identifier=e.name,this.viewData.activePreference.highlightedIndex=t,this.viewData},getDataToFilter:function(){return modelToPost},getScopeInfoFromModel:function(){return angular.copy(this.scopedInfo)},setScopeInfoIntoModel:function(e){this.scopedInfo={context:e.context,identifier:e.identifier,key:e.key,createdBy:o.getUserName()}},createFilterModel:n,setConfigurations:function(e){this.customOps=e}},a={removeOption:s,addOption:c},e={form:{identifier:"",showForm:!1,isDuplicate:!1,enabled:!0,record:[],viewData:[]},modelToPost:[],customOps:{},getFormData:function(){return this.form.record},putFormData:function(e){this.form.record.push(e)},getDefaultModel:function(){return{field:"",operator:"",value:"",logic:""}},createForm:function(){this.form.showForm=!0,this.form.identifier="",this.form.enabled=!0,this.form.record=[],this.form.isDuplicate=!1,this.form.record.push(this.getDefaultModel()),this.manupulateFormModel()},create:function(){var t=[],a=this.form.isDuplicate;angular.forEach(this.form.viewData,function(e,i){var r=a?"DUPLICATE":e.operator,o={field:e.field,operator:r,value:e.value,logic:e.logic,index:i};t.push(o)});var o={identifier:this.form.identifier,data:t};if(e&&e.customOps&&e.customOps.createPrefs&&"function"==typeof e.customOps.createPrefs.callbackFunc){this.modelToPost=angular.extend({},i.scopedInfo,o);var n={modelToPost:this.modelToPost,filerToApply:r};e.customOps.createPrefs.callbackFunc(n)}},preview:function(){var t=[],a=this.form.isDuplicate;angular.forEach(this.form.viewData,function(e,i){var r=a?"DUPLICATE":e.operator,o={field:e.field,operator:r,value:e.value,logic:e.logic,index:i};t.push(o)});var o={identifier:this.form.identifier,data:t};if(e&&e.customOps&&e.customOps.createPrefs&&"function"==typeof e.customOps.createPrefs.callbackFunc){this.modelToPost=angular.extend({},i.scopedInfo,o);var n={modelToPost:this.modelToPost,filerToApply:r};e.customOps.applyPrefs.callbackFunc(n)}},rebuildIndex:function(){angular.forEach(this.form.viewData,function(e,t){e.index=t})},validateForm:function(){var e={isValid:!0,message:"identifierAlreadyExist"},t=i.viewData.info,r=this.form.identifier.trim();return angular.forEach(t,function(t){r==t.name.trim()&&(e.isValid=!1)}),e.isValid},close:function(){this.form.showForm=!1;var a=this.form.viewData[0].value;t!=a&&(this.form.viewData[0].value=t);var o=_.filter(i.viewData.info,{name:i.viewData.activePreference.identifier});if(0===o.length){var n=[],s={identifier:"",data:n};if(e&&e.customOps&&e.customOps.createPrefs&&"function"==typeof e.customOps.createPrefs.callbackFunc){this.modelToPost=angular.extend({},i.scopedInfo,s);var c={modelToPost:this.modelToPost,filerToApply:r};e.customOps.applyPrefs.callbackFunc(c)}}else this.preview()},update:function(){var t=[],a=this.form.isDuplicate;angular.forEach(this.form.viewData,function(e,i){var r=a?"DUPLICATE":e.operator,o={field:e.field,operator:r,value:e.value,logic:e.logic,index:i};t.push(o)});var o={identifier:this.form.identifier,data:t};if(e&&e.customOps&&e.customOps.updatePrefs&&"function"==typeof e.customOps.updatePrefs.callbackFunc){this.modelToPost=angular.extend({},i.scopedInfo,o);var n={modelToPost:this.modelToPost,filerToApply:r};e.customOps.updatePrefs.callbackFunc(n)}},setConfigurations:function(e){this.customOps=e},manupulateFormModel:l};return{configurations:i,formConfigurations:e}}]),e.register.factory("gridFilteringService",["prefServiceUtil","configUrl",function(t,i){var e={};i.secureUrl+"site";return e.getUserPreferences=function(e){var i={method:"GET",url:"userPref",params:e};return t.httpGet(i)},e.addUserPreferences=function(e){var r={method:"POST",url:i.secureUrl+"preference/save",data:e};return t.httpSimulatePost(r)},e.updateUserPreferences=function(e){var r={method:"POST",url:i.secureUrl+"preference/save",data:e};return t.httpSimulatePost(r)},e.removeUserPreferences=function(e){var r={method:"GET",url:i.secureUrl+"preference/remove",params:e};return t.httpSimulateGet(r)},e}]),e.register.service("prefServiceUtil",["$http","configUrl","$q",function(e,a,t){function i(i){var e=o[i],t={};return t.start=function(){$(e.id).addClass(e["class"])},t.stop=function(){$(e.id).removeClass(e["class"])},t}var r={get:"get",post:"post"},o={get:{id:"#groupable-filter-menu>.dropdown-menu","class":"filterLoader"},post:{id:"#groupable-filter-menu>form.filter-rules>div:first-child","class":"advance-filter-loading"}};this.httpGet=function(o,c,l,f){o.url=a.baseServiceUrl+o.url,o.cache=!1;var n=t.defer(),s=i(r.get);return s.start(),e(o).success(function(e){s.stop(),n.resolve(e)}).error(function(e,t,i,r){s.stop(),n.reject(e)}),n.promise},this.httpPost=function(o,c,l){o.url=a.baseServiceUrl+o.url;var n=i(r.post);n.start();var s=t.defer();return e(o).success(function(e){n.stop(),s.resolve(e)}).error(function(e,t,i,r){n.stop(),s.reject(e)}),s.promise},this.httpSimulatePost=function(n,s,c){var a=i(r.post);a.start();var o=t.defer();return e(n).success(function(e){a.stop(),o.resolve(e)}).error(function(e,t,i,r){a.stop(),o.reject(e)}),o.promise},this.httpSimulateGet=function(a,s,c,l){a.cache=!1,a.params=a.params?a.params:{},a.params.time=Date.now();var n=i(r.post);n.start();var o=t.defer();return e(a).success(function(e){n.stop(),e.isSuccess?o.resolve(e):o.resolve(e)}).error(function(e,t,i,r){n.stop(),o.reject(e)}),o.promise}}])})}();